<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BreatheScan-L | Test Model</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/tailwind.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">

</head>

<body class="bg-gray-50">
  {% include "components/navbar.html" %}


  <!-- TEST MODEL PAGE -->
  <section class="py-20 bg-gradient-to-br from-blue-50 to-purple-100">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="text-center mb-12">
        <h1 class="text-5xl font-bold text-gray-900 mb-6">AI Liver Disease Test</h1>
        <p class="text-xl text-gray-600">Upload your data for liver disease risk evaluation</p>
      </div>

      <div class="bg-white rounded-3xl shadow-2xl overflow-hidden">
        <div id="uploadSection" class="p-12" style="display: {{ 'none' if analysis else 'block' }};">
          <form id="testForm" action="{{ url_for('test') }}" method="POST" enctype="multipart/form-data">
            <!-- Progress Bar -->
            <div class="bg-gray-200 h-2 mb-8 rounded-full">
              <div id="progress" class="bg-gradient-to-r from-blue-500 to-purple-600 h-2 rounded-full"
                style="width: 0%;">
              </div>
            </div>

            <!-- Step 1 -->
            <div id="step1" class="test-step">
              <h2 class="text-3xl font-bold text-gray-900 mb-8">Step 1: Upload Files</h2>
              <div class="grid md:grid-cols-2 gap-8">
                <!-- Eye -->
                <div
                  class="upload-box border-2 border-dashed border-gray-300 rounded-2xl p-8 text-center hover:border-blue-400">
                  <h3 class="text-xl font-semibold text-gray-900 mb-2">Eye Image</h3>
                  <input type="file" name="eyeImage" id="eyeImage" accept="image/*" class="hidden"
                    onchange="showFile(this, 'eyeFileName', 'eyeButton', 'eyePreview')">
                  <button id="eyeButton" type="button" onclick="document.getElementById('eyeImage').click()"
                    class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">Choose File</button>
                  <p id="eyeFileName" class="mt-3 text-sm text-gray-500"></p>
                  <img id="eyePreview" class="hidden mx-auto mt-4 rounded-lg shadow-md max-h-40">
                </div>

                <!-- Skin -->
                <div
                  class="upload-box border-2 border-dashed border-gray-300 rounded-2xl p-8 text-center hover:border-blue-400">
                  <h3 class="text-xl font-semibold text-gray-900 mb-2">Skin Image</h3>
                  <input type="file" name="skinImage" id="skinImage" accept="image/*" class="hidden"
                    onchange="showFile(this, 'skinFileName', 'skinButton', 'skinPreview')">
                  <button id="skinButton" type="button" onclick="document.getElementById('skinImage').click()"
                    class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">Choose File</button>
                  <p id="skinFileName" class="mt-3 text-sm text-gray-500"></p>
                  <img id="skinPreview" class="hidden mx-auto mt-4 rounded-lg shadow-md max-h-40">
                </div>

                <!-- E-nose -->
                <div
                  class="upload-box border-2 border-dashed border-gray-300 rounded-2xl p-8 text-center hover:border-blue-400">
                  <h3 class="text-xl font-semibold text-gray-900 mb-2">E-nose CSV</h3>
                  <input type="file" name="enoseCSV" id="enoseCSV" accept=".csv" class="hidden"
                    onchange="showFile(this, 'enoseFileName', 'enoseButton')">
                  <button id="enoseButton" type="button" onclick="document.getElementById('enoseCSV').click()"
                    class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">Choose File</button>
                  <p id="enoseFileName" class="mt-3 text-sm text-gray-500"></p>
                </div>

                <!-- Questionnaire -->
                <div
                  class="upload-box border-2 border-dashed border-gray-300 rounded-2xl p-8 text-center hover:border-blue-400">
                  <h3 class="text-xl font-semibold text-gray-900 mb-2">Questionnaire CSV</h3>

                  <button type="button" onclick="openQSModal()"
                    class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700">
                    Select from Questionnaire History
                  </button>

                  <p id="selectedQS" class="mt-3 text-sm text-gray-600"></p>

                  <!-- hidden input ‡∏™‡πà‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏õ backend -->
                  <input type="hidden" name="questionnaire_file" id="questionnaire_file">
                </div>

                <!-- ================= QS MODAL ================= -->
                <div id="qsModal"
                  class="fixed inset-0 bg-black bg-opacity-40 hidden z-50 flex items-center justify-center">
                  <div class="bg-white rounded-2xl w-full max-w-md mx-auto px-4 p-6 shadow-2xl">
                    <h3 class="text-xl font-bold mb-4">Select Questionnaire</h3>

                    <ul id="qsList" class="max-h-64 overflow-y-auto space-y-2 text-left"></ul>

                    <div class="text-right mt-4">
                      <button onclick="closeQSModal()"
                        class="px-4 py-2 bg-gray-400 text-white rounded-lg hover:bg-gray-500">
                        Close
                      </button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="text-center mt-8">
                <button id="submitBtn" type="submit"
                  class="bg-gradient-to-r from-blue-600 to-purple-600 text-white px-8 py-3 rounded-lg font-semibold hover:from-blue-700 hover:to-purple-700">
                  Submit & Analyze
                </button>

                <!-- processing overlay icon -->
                <div id="processingOverlay" class="hidden mt-4 text-center">
                  <div class="inline-flex items-center gap-3 text-gray-600">
                    <svg class="animate-spin h-6 w-6 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none"
                      viewBox="0 0 24 24">
                      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
                    </svg>
                    Processing...
                  </div>
                </div>

              </div>
            </div>
          </form>
        </div>
        <div id="resultSection" class="p-8 border-t" style="display: {{ 'block' if analysis else 'none' }};">
          {% if analysis %}

          {# ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÇ‡∏î‡∏¢‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å chat_messages #}
          {% set risk_level = "N/A" %}
          {% set risk_prob = 0 %}
          {% set qs_score = 0 %}
          {% set diagnosis = "Not available" %}
          {% set recommendation = "No recommendation available." %}
          {% for msg in analysis.chat_messages %}
          {% if msg.name == 'risk_level' %}{% set risk_level = msg.content %}{% endif %}
          {% if msg.name == 'risk_probability' %}{% set risk_prob = msg.content %}{% endif %}
          {% if msg.name == 'questionnaire_score' %}{% set qs_score = msg.content %}{% endif %}
          {% if msg.name == 'diagnosis' %}{% set diagnosis = msg.content %}{% endif %}
          {% if msg.name == 'recommendation' %}{% set recommendation = msg.content %}{% endif %}
          {% endfor %}

          <div class="flex flex-col md:flex-row justify-between items-center mb-10 gap-4">
            <div>
              <h3 class="text-3xl font-bold text-gray-900">Analysis Result</h3>
              <p class="text-gray-500 text-sm">Run ID: <span id="runIdText">{{ run_id }}</span> ‚Ä¢ <span id="reportDate"
                  class="text-gray-400"></span></p>
            </div>
            <div class="flex items-center gap-3">
              <a id="downloadReport" href="#" download
                class="px-4 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700">Download Report</a>
              <button id="backBtn"
                class="px-5 py-2.5 bg-white border border-gray-200 text-gray-600 rounded-xl font-medium hover:bg-gray-50 transition-all"
                onclick="showUpload(); return false;">New Test</button>
            </div>
          </div>

          <!-- Clinical-style Summary Card -->
          <div class="bg-white rounded-3xl p-6 mb-8 border border-gray-100 shadow-md">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
              <div>
                <h4 class="text-xl font-bold text-gray-900">Clinician Summary</h4>
                <p class="text-sm text-gray-600 mt-1">A concise interpretation of the model's findings.</p>
              </div>
              <div class="text-right">
                <span class="text-xs text-gray-400">Generated:</span>
                <div class="text-sm text-gray-700" id="summaryDate">{{ run_id }} ‚Ä¢ <span id="reportDateSmall"></span>
                </div>
              </div>
            </div>

            <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
              <div class="md:col-span-2">
                <h5 class="text-sm font-semibold text-gray-500">Preliminary Diagnosis</h5>
                <p id="diagnosisText" class="text-lg font-bold text-gray-900 mt-2">{{ diagnosis }}</p>

                <h5 class="text-sm font-semibold text-gray-500 mt-4">Recommendation</h5>
                <p id="recommendationText" class="text-sm text-gray-700 mt-2">{{ recommendation }}</p>
              </div>

              <div
                class="bg-gradient-to-br from-white to-gray-50 p-4 rounded-2xl border border-gray-100 shadow-sm text-center">
                <div class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Risk</div>
                <div id="riskLevelText" class="text-2xl font-black mt-2
                  {% if risk_level|lower == 'high' %}text-red-600
                  {% elif risk_level|lower == 'medium' %}text-yellow-600
                  {% else %}text-green-600{% endif %}">
                  {{ risk_level }}
                </div>
                <div id="riskProbText" class="text-sm text-gray-500 mt-1">{{ (risk_prob|float * 100)|round(1) }}%</div>
              </div>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
            <!-- Risk Level Card -->
            <div class="bg-white p-6 rounded-3xl border border-gray-100 shadow-sm">
              <div class="flex items-center justify-between">
                <div>
                  <div class="text-xs font-semibold text-gray-400 uppercase">Risk Level</div>
                  <div class="mt-2 text-2xl font-extrabold
                    {% if risk_level|lower == 'high' %}text-red-600
                    {% elif risk_level|lower == 'medium' %}text-yellow-600
                    {% else %}text-green-600{% endif %}">
                    {{ risk_level }}
                  </div>
                </div>
                <div class="text-right">
                  <div class="text-sm text-gray-500">Interpretation</div>
                  <div class="mt-1 text-xs text-gray-600">
                    {% if risk_level|lower == 'high' %}Urgent follow-up recommended
                    {% elif risk_level|lower == 'medium' %}Consider further tests
                    {% else %}Low immediate concern{% endif %}
                  </div>
                </div>
              </div>
            </div>

            <!-- Risk Probability Card -->
            <div class="bg-white p-6 rounded-3xl border border-gray-100 shadow-sm">
              <div>
                <div class="text-xs font-semibold text-gray-400 uppercase">Risk Probability</div>
                <div class="mt-2 text-2xl font-extrabold text-blue-600">{{ (risk_prob|float * 100)|round(1) }}%</div>
                <div class="mt-2 text-xs text-gray-600">Probability estimate from model ‚Äî use clinically with other
                  data.</div>
              </div>
            </div>

            <!-- Questionnaire Score Card -->
            <div class="bg-white p-6 rounded-3xl border border-gray-100 shadow-sm">
              <div>
                <div class="text-xs font-semibold text-gray-400 uppercase">QS Score</div>
                <div id="qsScoreText" class="mt-2 text-2xl font-extrabold text-purple-600">{{ qs_score }}</div>
                <div class="mt-2 text-xs text-gray-600">Higher score indicates more symptoms/risk factors.</div>
              </div>
            </div>
          </div>

          <div class="grid lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 space-y-8">
              {% if analysis.processed_image %}
              <div class="bg-white rounded-3xl p-6 border border-gray-100 shadow-sm">
                <h4 class="text-lg font-bold text-gray-900 mb-4">Analysis Visualization</h4>
                <div class="relative rounded-2xl overflow-hidden bg-gray-100">
                  <img src="{{ analysis.processed_image }}" class="w-full h-auto object-contain max-h-[500px]"
                    alt="Processed Image">
                </div>
              </div>
              {% endif %}

              {% if analysis.per_image %}
              <div>
                <h4 class="text-lg font-bold text-gray-900 mb-4">Input Comparison</h4>
                <div class="grid sm:grid-cols-2 gap-4">
                  {% for p in analysis.per_image %}
                  <div class="bg-white p-4 rounded-2xl border border-gray-100 shadow-sm flex flex-col gap-4">
                    <div class="flex items-center gap-3">
                      <img src="{{ p.result_image }}" class="w-16 h-16 rounded-xl object-cover border border-gray-100"
                        alt="per-image">
                      <div class="overflow-hidden">
                        <p class="text-xs text-gray-400 font-bold uppercase">{{ p.get('input_type', 'Detection') }}</p>
                        <p class="text-sm font-medium text-gray-700 truncate">{{ p.filename }}</p>
                      </div>
                    </div>
                  </div>
                  {% endfor %}
                </div>
              </div>
              {% endif %}
            </div>

            <div class="space-y-6">
              <div class="bg-white rounded-3xl p-6 border border-gray-100 shadow-sm">
                <h4 class="text-base font-bold text-gray-900 mb-4">Feature Breakdown</h4>
                <div class="space-y-3">
                  {% for msg in analysis.chat_messages %}
                  {% if 'risk' in msg.name %}
                  <div class="flex justify-between items-center pb-2 border-b border-gray-50">
                    <span class="text-sm text-gray-500">{{ msg.name|replace('_', ' ')|title }}</span>
                    <span class="text-sm font-bold text-gray-800">{{ msg.content }}</span>
                  </div>
                  {% endif %}
                  {% endfor %}
                </div>
              </div>

              <div class="bg-gray-900 rounded-3xl p-6 text-white shadow-xl">
                <h4 class="text-base font-bold mb-4 flex items-center gap-2">
                  üìÅ System Files
                </h4>
                <div class="space-y-4">
                  <div>
                    <p class="text-[10px] text-gray-500 font-bold uppercase mb-2">Result Folder</p>
                    <ul class="space-y-2">
                      {% for f in analysis.result_files %}
                      <li>
                        <a href="{{ f.url }}" target="_blank"
                          class="text-xs text-green-400 hover:text-green-300 flex items-center gap-2 transition-colors">
                          <span class="truncate">{{ f.name }}</span>
                        </a>
                      </li>
                      {% endfor %}
                    </ul>
                  </div>
                  <div class="pt-4 border-t border-gray-800">
                    <p class="text-[10px] text-gray-500 font-bold uppercase mb-2">Upload Folder</p>
                    <ul class="space-y-2">
                      {% for f in analysis.run_files %}
                      <li>
                        <a href="{{ f.url }}" target="_blank"
                          class="text-xs text-blue-400 hover:text-blue-300 flex items-center gap-2 transition-colors">
                          <span class="truncate">{{ f.name }}</span>
                        </a>
                      </li>
                      {% endfor %}
                    </ul>
                  </div>
                </div>
              </div>
            </div>
          </div>
          {% endif %}
        </div>

        <script>
          // Defensive: only set reportDate if the element exists
          const reportEl = document.getElementById('reportDate');
          if (reportEl) reportEl.innerText = new Date().toLocaleString();
          const reportElSmall = document.getElementById('reportDateSmall');
          if (reportElSmall) reportElSmall.innerText = new Date().toLocaleString();

          // Download report fallback: build JSON from DOM and trigger a download (client-side)
          (function () {
            const btn = document.getElementById('downloadReport');
            if (!btn) return;
            btn.addEventListener('click', function (ev) {
              ev.preventDefault();
              try {
                const runId = document.getElementById('runIdText') ? document.getElementById('runIdText').innerText.trim() : '';
                const riskLevel = document.getElementById('riskLevelText') ? document.getElementById('riskLevelText').innerText.trim() : '';
                const riskProb = document.getElementById('riskProbText') ? document.getElementById('riskProbText').innerText.replace('%', '').trim() : '';
                const qsScore = document.getElementById('qsScoreText') ? document.getElementById('qsScoreText').innerText.trim() : '';
                const diagnosis = document.getElementById('diagnosisText') ? document.getElementById('diagnosisText').innerText.trim() : '';
                const recommendation = document.getElementById('recommendationText') ? document.getElementById('recommendationText').innerText.trim() : '';

                const report = {
                  run_id: runId,
                  generated_at: new Date().toISOString(),
                  risk_level: riskLevel,
                  risk_probability_percent: riskProb,
                  qs_score: qsScore,
                  diagnosis: diagnosis,
                  recommendation: recommendation
                };

                const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `report_${runId || 'report'}.json`;
                document.body.appendChild(a);
                a.click();
                a.remove();
                URL.revokeObjectURL(url);
              } catch (err) {
                console.error('Download failed', err);
              }
            });
          })();
        </script>
        {# duplicate block removed - concise single result view above is used #}
      </div>
    </div>
  </section>

  <script>
    function showFile(input, labelId, buttonId, previewId = null) {
      const label = document.getElementById(labelId);
      const button = document.getElementById(buttonId);
      const preview = previewId ? document.getElementById(previewId) : null;

      if (input.files && input.files[0]) {
        const file = input.files[0];
        label.textContent = `‚úÖ ${file.name}`;
        label.classList.add("text-green-600", "font-medium");
        button.textContent = "Uploaded ‚úì";
        button.classList.add("bg-green-600");
        if (preview && file.type.startsWith("image/")) {
          const reader = new FileReader();
          reader.onload = e => {
            preview.src = e.target.result;
            preview.classList.remove("hidden");
          };
          reader.readAsDataURL(file);
        }
      }
    }

    let currentStep = 1;
    function nextStep(n) {
      const steps = document.querySelectorAll(".test-step");
      if (!steps || steps.length === 0) return;

      // clamp target step
      const target = Math.max(1, Math.min(n, steps.length));

      steps.forEach(s => s.classList.add("hidden"));
      const targetEl = document.getElementById(`step${target}`);
      if (targetEl) targetEl.classList.remove("hidden");

      const progress = document.getElementById("progress");
      if (progress) {
        const denom = Math.max(1, (steps.length - 1));
        progress.style.width = `${((target - 1) / denom) * 100}%`;
      }
      currentStep = target;
    }
    function prevStep() {
      if (currentStep > 1) nextStep(currentStep - 1);
    }
  </script>
  <script>
    // show overlay while submitting
    const form = document.getElementById('testForm');
    form.addEventListener('submit', () => {
      document.getElementById('processingOverlay').classList.remove('hidden');
      document.getElementById('submitBtn').disabled = true;
    });
  </script>
  <script src="{{ url_for('static', filename='js/user_menu.js') }}"></script>
  <script>
    function openQSModal() {
      fetch("/api/qs/list")
        .then(res => res.json())
        .then(data => {
          const list = document.getElementById("qsList");
          list.innerHTML = "";

          if (!data.files.length) {
            list.innerHTML = "<li class='text-gray-500'>No questionnaire found</li>";
            return;
          }

          data.files.forEach(file => {
            const li = document.createElement("li");
            li.className = "p-2 border rounded-lg hover:bg-blue-50 cursor-pointer";
            li.innerText = file;
            li.onclick = () => selectQS(file);
            list.appendChild(li);
          });

          document.getElementById("qsModal").classList.remove("hidden");
        });
    }

    function closeQSModal() {
      document.getElementById("qsModal").classList.add("hidden");
    }

    function selectQS(filename) {
      document.getElementById("questionnaire_file").value = filename;
      document.getElementById("selectedQS").innerText = "‚úÖ " + filename;
      closeQSModal();
    }
  </script>
  <script>
    // Toggle between upload and result sections
    function showUpload() {
      const upload = document.getElementById('uploadSection');
      const result = document.getElementById('resultSection');
      upload.style.display = 'block';
      result.style.display = 'none';
      // reset submit button & overlay
      const submitBtn = document.getElementById('submitBtn');
      if (submitBtn) submitBtn.disabled = false;
      const overlay = document.getElementById('processingOverlay');
      if (overlay) overlay.classList.add('hidden');
    }

    function showResult() {
      const upload = document.getElementById('uploadSection');
      const result = document.getElementById('resultSection');
      upload.style.display = 'none';
      result.style.display = 'block';
    }
  </script>

</body>

</html>