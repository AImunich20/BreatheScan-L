<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BreatheScan-L | Test Model</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/tailwind.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">

</head>

<body class="bg-gray-50">
  {% include "components/navbar.html" %}


  <!-- TEST MODEL PAGE -->
  <section class="py-20 bg-gradient-to-br from-blue-50 to-purple-100">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="text-center mb-12">
        <h1 class="text-5xl font-bold text-gray-900 mb-6">AI Liver Disease Test</h1>
        <p class="text-xl text-gray-600">Upload your data for liver disease risk evaluation</p>
      </div>

      <div class="bg-white rounded-3xl shadow-2xl overflow-hidden">
        <div id="uploadSection" class="p-12" style="display: {{ 'none' if analysis else 'block' }};">
          <form id="testForm" action="{{ url_for('test') }}" method="POST" enctype="multipart/form-data">
          <!-- Progress Bar -->
          <div class="bg-gray-200 h-2 mb-8 rounded-full">
            <div id="progress" class="bg-gradient-to-r from-blue-500 to-purple-600 h-2 rounded-full" style="width: 0%;">
            </div>
          </div>

          <!-- Step 1 -->
          <div id="step1" class="test-step">
            <h2 class="text-3xl font-bold text-gray-900 mb-8">Step 1: Upload Files</h2>
            <div class="grid md:grid-cols-2 gap-8">
              <!-- Eye -->
              <div
                class="upload-box border-2 border-dashed border-gray-300 rounded-2xl p-8 text-center hover:border-blue-400">
                <h3 class="text-xl font-semibold text-gray-900 mb-2">Eye Image</h3>
                <input type="file" name="eyeImage" id="eyeImage" accept="image/*" class="hidden"
                  onchange="showFile(this, 'eyeFileName', 'eyeButton', 'eyePreview')">
                <button id="eyeButton" type="button" onclick="document.getElementById('eyeImage').click()"
                  class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">Choose File</button>
                <p id="eyeFileName" class="mt-3 text-sm text-gray-500"></p>
                <img id="eyePreview" class="hidden mx-auto mt-4 rounded-lg shadow-md max-h-40">
              </div>

              <!-- Skin -->
              <div
                class="upload-box border-2 border-dashed border-gray-300 rounded-2xl p-8 text-center hover:border-blue-400">
                <h3 class="text-xl font-semibold text-gray-900 mb-2">Skin Image</h3>
                <input type="file" name="skinImage" id="skinImage" accept="image/*" class="hidden"
                  onchange="showFile(this, 'skinFileName', 'skinButton', 'skinPreview')">
                <button id="skinButton" type="button" onclick="document.getElementById('skinImage').click()"
                  class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">Choose File</button>
                <p id="skinFileName" class="mt-3 text-sm text-gray-500"></p>
                <img id="skinPreview" class="hidden mx-auto mt-4 rounded-lg shadow-md max-h-40">
              </div>

              <!-- E-nose -->
              <div
                class="upload-box border-2 border-dashed border-gray-300 rounded-2xl p-8 text-center hover:border-blue-400">
                <h3 class="text-xl font-semibold text-gray-900 mb-2">E-nose CSV</h3>
                <input type="file" name="enoseCSV" id="enoseCSV" accept=".csv" class="hidden"
                  onchange="showFile(this, 'enoseFileName', 'enoseButton')">
                <button id="enoseButton" type="button" onclick="document.getElementById('enoseCSV').click()"
                  class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">Choose File</button>
                <p id="enoseFileName" class="mt-3 text-sm text-gray-500"></p>
              </div>

              <!-- Questionnaire -->
              <div
                class="upload-box border-2 border-dashed border-gray-300 rounded-2xl p-8 text-center hover:border-blue-400">
                <h3 class="text-xl font-semibold text-gray-900 mb-2">Questionnaire CSV</h3>

                <button type="button" onclick="openQSModal()"
                  class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700">
                  Select from Questionnaire History
                </button>

                <p id="selectedQS" class="mt-3 text-sm text-gray-600"></p>

                <!-- hidden input ส่งชื่อไฟล์ไป backend -->
                <input type="hidden" name="questionnaire_file" id="questionnaire_file">
              </div>

              <!-- ================= QS MODAL ================= -->
              <div id="qsModal"
                class="fixed inset-0 bg-black bg-opacity-40 hidden z-50 flex items-center justify-center">
                <div class="bg-white rounded-2xl w-full max-w-md mx-auto px-4 p-6 shadow-2xl">
                  <h3 class="text-xl font-bold mb-4">Select Questionnaire</h3>

                  <ul id="qsList" class="max-h-64 overflow-y-auto space-y-2 text-left"></ul>

                  <div class="text-right mt-4">
                    <button onclick="closeQSModal()"
                      class="px-4 py-2 bg-gray-400 text-white rounded-lg hover:bg-gray-500">
                      Close
                    </button>
                  </div>
                </div>
              </div>
            </div>
            <div class="text-center mt-8">
              <button id="submitBtn" type="submit"
                class="bg-gradient-to-r from-blue-600 to-purple-600 text-white px-8 py-3 rounded-lg font-semibold hover:from-blue-700 hover:to-purple-700">
                Submit & Analyze
              </button>

              <!-- processing overlay icon -->
              <div id="processingOverlay" class="hidden mt-4 text-center">
                <div class="inline-flex items-center gap-3 text-gray-600">
                  <svg class="animate-spin h-6 w-6 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
                  </svg>
                  Processing...
                </div>
              </div>

            </div>
          </div>
          </form>
        </div>
        <div id="resultSection" class="p-8 border-t" style="display: {{ 'block' if analysis else 'none' }};">
  {% if analysis and analysis.chat_messages %}
          <div class="flex justify-between items-center mb-4">
            <div>
              <h3 class="text-2xl font-bold">Analysis Result</h3>
              <div class="text-sm text-gray-500">Run: <strong>{{ run_id }}</strong></div>
            </div>
            <div class="flex items-center gap-2">
              <a href="{{ url_for('run_file', filepath=run_id + '/result/analysis_result.json') }}" class="px-3 py-2 bg-blue-600 text-white rounded">Download JSON</a>
              <button id="backBtn" class="px-4 py-2 bg-gray-200 rounded" onclick="showUpload(); return false;">Back</button>
            </div>
          </div>
          <div class="bg-white rounded p-6 shadow-sm">
            <h4 class="font-semibold mb-4">Analysis Overview</h4>

            <div class="grid md:grid-cols-2 gap-4 mb-6">
              <div class="p-3 border rounded text-center">
                <div class="text-sm text-gray-600 mb-2">Risk breakdown</div>
                <div style="width:100%;max-width:320px;margin:0 auto;aspect-ratio:1/1;">
                  <canvas id="riskPie"></canvas>
                </div>
              </div>
              <div class="p-3 border rounded">
                <div class="text-sm text-gray-600 mb-2">Image & Sensor features</div>
                <div style="width:100%;max-width:460px;margin:0 auto;aspect-ratio:16/9;">
                  <canvas id="featuresLine"></canvas>
                </div>
              </div>
            </div>

            <h4 class="font-semibold mb-3">Analysis Chat</h4>
            <div class="space-y-3">
              {% for m in analysis.chat_messages %}
                <div class="p-3 rounded-lg bg-gray-100">
                  <div class="text-xs text-gray-500">{{ m.name }}</div>
                  <pre class="text-sm text-gray-800 whitespace-pre-wrap">{{ m.content }}</pre>
                </div>
              {% endfor %}
            </div>
          </div>
        {% endif %}
        </div>
  {# duplicate block removed - concise single result view above is used #}
      </div>
    </div>
  </section>

  <script>
    function showFile(input, labelId, buttonId, previewId = null) {
      const label = document.getElementById(labelId);
      const button = document.getElementById(buttonId);
      const preview = previewId ? document.getElementById(previewId) : null;

      if (input.files && input.files[0]) {
        const file = input.files[0];
        label.textContent = `✅ ${file.name}`;
        label.classList.add("text-green-600", "font-medium");
        button.textContent = "Uploaded ✓";
        button.classList.add("bg-green-600");
        if (preview && file.type.startsWith("image/")) {
          const reader = new FileReader();
          reader.onload = e => {
            preview.src = e.target.result;
            preview.classList.remove("hidden");
          };
          reader.readAsDataURL(file);
        }
      }
    }

    let currentStep = 1;
    function nextStep(n) {
      const steps = document.querySelectorAll(".test-step");
      steps.forEach(s => s.classList.add("hidden"));
      document.getElementById(`step${n}`).classList.remove("hidden");
      const progress = document.getElementById("progress");
      progress.style.width = `${((n - 1) / (steps.length - 1)) * 100}%`;
      currentStep = n;
    }
    function prevStep() {
      if (currentStep > 1) nextStep(currentStep - 1);
    }
  </script>
  <script>
    // show overlay while submitting
    const form = document.getElementById('testForm');
    form.addEventListener('submit', () => {
      document.getElementById('processingOverlay').classList.remove('hidden');
      document.getElementById('submitBtn').disabled = true;
    });
  </script>
  <script src="{{ url_for('static', filename='js/user_menu.js') }}"></script>
  <script>
    function openQSModal() {
      fetch("/api/qs/list")
        .then(res => res.json())
        .then(data => {
          const list = document.getElementById("qsList");
          list.innerHTML = "";

          if (!data.files.length) {
            list.innerHTML = "<li class='text-gray-500'>No questionnaire found</li>";
            return;
          }

          data.files.forEach(file => {
            const li = document.createElement("li");
            li.className = "p-2 border rounded-lg hover:bg-blue-50 cursor-pointer";
            li.innerText = file;
            li.onclick = () => selectQS(file);
            list.appendChild(li);
          });

          document.getElementById("qsModal").classList.remove("hidden");
        });
    }

    function closeQSModal() {
      document.getElementById("qsModal").classList.add("hidden");
    }

    function selectQS(filename) {
      document.getElementById("questionnaire_file").value = filename;
      document.getElementById("selectedQS").innerText = "✅ " + filename;
      closeQSModal();
    }
  </script>
  <script>
    // Toggle between upload and result sections
    function showUpload() {
      const upload = document.getElementById('uploadSection');
      const result = document.getElementById('resultSection');
      upload.style.display = 'block';
      result.style.display = 'none';
      // reset submit button & overlay
      const submitBtn = document.getElementById('submitBtn');
      if (submitBtn) submitBtn.disabled = false;
      const overlay = document.getElementById('processingOverlay');
      if (overlay) overlay.classList.add('hidden');
    }

    function showResult() {
      const upload = document.getElementById('uploadSection');
      const result = document.getElementById('resultSection');
      upload.style.display = 'none';
      result.style.display = 'block';
    }
  </script>

  <script>
    // Set color swatches from data-rgb to avoid template/CSS lint issues
    document.addEventListener('DOMContentLoaded', function() {
      var swatches = document.querySelectorAll('[data-rgb]');
      swatches.forEach(function(el) {
        var rgb = el.getAttribute('data-rgb');
        if (!rgb) return;
        el.style.backgroundColor = 'rgb(' + rgb + ')';
      });
    });
  </script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script type="application/json" id="analysisJson">{{ analysis | tojson | safe }}</script>
  <script>
    (function(){
      try{
        const raw = document.getElementById('analysisJson')?.textContent || '{}';
        const analysis = JSON.parse(raw);
        const messages = analysis.chat_messages || [];

        // parse risk breakdown
        const risk = {};
        messages.forEach(m => {
          if (m.name === 'risk_breakdown') {
            Object.assign(risk, m.content || {});
          }
          // also allow individual risk items
          if (m.name === 'image_risk') risk.image_risk = m.content;
          if (m.name === 'sensor_risk') risk.sensor_risk = m.content;
          if (m.name === 'questionnaire_risk') risk.questionnaire_risk = m.content;
        });

        const pieLabels = ['Image', 'Sensor', 'Questionnaire'];
        const pieData = [risk.image_risk||0, risk.sensor_risk||0, risk.questionnaire_risk||0];

        const ctxPie = document.getElementById('riskPie');
        if (ctxPie) {
          new Chart(ctxPie.getContext('2d'), {
            type: 'pie',
            data: {
              labels: pieLabels,
              datasets: [{
                data: pieData,
                backgroundColor: ['#ef4444','#f59e0b','#10b981']
              }]
            },
            options: {responsive:true, maintainAspectRatio:true}
          });
        }

        // features line chart - use first found image_features and sensor_features
        let imgFeat = null, sensFeat = null;
        messages.forEach(m => {
          if (m.name === 'image_features') imgFeat = Array.isArray(m.content) ? m.content : null;
          if (m.name === 'sensor_features') sensFeat = Array.isArray(m.content) ? m.content : null;
        });
        if (!imgFeat && messages.length) {
          // scan numeric arrays in messages fallback
          for (let m of messages) {
            if (!imgFeat && Array.isArray(m.content) && m.content.length>=3) imgFeat = m.content;
            if (!sensFeat && Array.isArray(m.content) && m.content.length>=3) sensFeat = m.content;
          }
        }

        const ctxLine = document.getElementById('featuresLine');
        if (ctxLine && (imgFeat || sensFeat)) {
          const labels = imgFeat ? imgFeat.map((_,i)=>`F${i+1}`) : (sensFeat? sensFeat.map((_,i)=>`S${i+1}`):[]);
          new Chart(ctxLine.getContext('2d'), {
            type: 'line',
            data: {
              labels: labels,
              datasets: [
                imgFeat ? {label:'Image features', data: imgFeat, borderColor:'#3b82f6', fill:false} : null,
                sensFeat ? {label:'Sensor features', data: sensFeat, borderColor:'#8b5cf6', fill:false} : null
              ].filter(Boolean)
            },
            options: {responsive:true, maintainAspectRatio:true}
          });
        }
      }catch(e){console.warn('Chart init failed', e)}
    })();
  </script>

</body>

</html>